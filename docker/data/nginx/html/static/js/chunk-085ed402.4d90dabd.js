(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-085ed402","chunk-6ffdf140","chunk-2d0a3715"],{"01ca":function(e,t,n){"use strict";n.d(t,"f",(function(){return i})),n.d(t,"d",(function(){return o})),n.d(t,"a",(function(){return s})),n.d(t,"e",(function(){return a})),n.d(t,"g",(function(){return l})),n.d(t,"c",(function(){return c})),n.d(t,"b",(function(){return u}));var r=n("b775");function i(e){return Object(r["a"])({url:"/iot/model/list",method:"get",params:e})}function o(e){return Object(r["a"])({url:"/iot/model/"+e,method:"get"})}function s(e){return Object(r["a"])({url:"/iot/model",method:"post",data:e})}function a(e){return Object(r["a"])({url:"/iot/model/import",method:"post",data:e})}function l(e){return Object(r["a"])({url:"/iot/model",method:"put",data:e})}function c(e){return Object(r["a"])({url:"/iot/model/"+e,method:"delete"})}function u(e){return Object(r["a"])({url:"/iot/model/cache/"+e,method:"get"})}},"3b61":function(e,t,n){"use strict";n.r(t);var r=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticStyle:{padding:"6px"}},[n("el-card",{directives:[{name:"show",rawName:"v-show",value:e.showSearch,expression:"showSearch"}],staticStyle:{"margin-bottom":"6px"}},[n("el-form",{directives:[{name:"show",rawName:"v-show",value:e.showSearch,expression:"showSearch"}],ref:"queryForm",staticStyle:{"margin-bottom":"-20px"},attrs:{model:e.queryParams,inline:!0,"label-width":"68px"}},[n("el-form-item",{attrs:{label:"场景名称",prop:"sceneName"}},[n("el-input",{attrs:{placeholder:"请输入场景名称",clearable:"",size:"small"},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleQuery(t)}},model:{value:e.queryParams.sceneName,callback:function(t){e.$set(e.queryParams,"sceneName",t)},expression:"queryParams.sceneName"}})],1),n("el-form-item",[n("el-button",{attrs:{type:"primary",icon:"el-icon-search",size:"mini"},on:{click:e.handleQuery}},[e._v("搜索")]),n("el-button",{attrs:{icon:"el-icon-refresh",size:"mini"},on:{click:e.resetQuery}},[e._v("重置")])],1),n("el-form-item",{staticStyle:{float:"right"}},[n("el-button",{directives:[{name:"hasPermi",rawName:"v-hasPermi",value:["iot:scene:add"],expression:"['iot:scene:add']"}],attrs:{type:"primary",plain:"",icon:"el-icon-plus",size:"mini"},on:{click:e.handleAdd}},[e._v("新增")])],1)],1)],1),n("el-card",{staticStyle:{"padding-bottom":"100px"}},[n("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],attrs:{data:e.sceneList,border:""},on:{"selection-change":e.handleSelectionChange}},[n("el-table-column",{attrs:{label:"场景名称",align:"center",prop:"sceneName"}}),n("el-table-column",{attrs:{label:"状态",align:"center",prop:"status",width:"120"},scopedSlots:e._u([{key:"default",fn:function(t){return[1==t.row.status?n("el-tag",{attrs:{type:"success",size:"small"}},[e._v("启动")]):e._e(),2==t.row.status?n("el-tag",{attrs:{type:"danger",size:"small"}},[e._v("暂停")]):e._e()]}}])}),n("el-table-column",{attrs:{label:"触发器",align:"left","header-align":"center",prop:"triggers","min-width":"120"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("div",{domProps:{innerHTML:e._s(e.formatTriggersDisplay(t.row.triggers))}})]}}])}),n("el-table-column",{attrs:{label:"执行动作",align:"left","header-align":"center",prop:"actions","min-width":"100"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("div",{domProps:{innerHTML:e._s(e.formatActionsDisplay(t.row.actions))}})]}}])}),n("el-table-column",{attrs:{label:"创建时间",align:"center",prop:"createTime",width:"120"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("span",[e._v(e._s(e.parseTime(t.row.createTime,"{y}-{m}-{d}")))])]}}])}),n("el-table-column",{attrs:{label:"操作",align:"center",width:"150"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("el-button",{directives:[{name:"hasPermi",rawName:"v-hasPermi",value:["iot:scene:add"],expression:"['iot:scene:add']"}],attrs:{size:"mini",type:"text",icon:"el-icon-view"},on:{click:function(n){return e.handleUpdate(t.row)}}},[e._v("查看")]),n("el-button",{directives:[{name:"hasPermi",rawName:"v-hasPermi",value:["iot:scene:remove"],expression:"['iot:scene:remove']"}],attrs:{size:"mini",type:"text",icon:"el-icon-delete"},on:{click:function(n){return e.handleDelete(t.row)}}},[e._v("删除")]),n("el-button",{directives:[{name:"hasPermi",rawName:"v-hasPermi",value:["iot:scene:edit"],expression:"['iot:scene:edit']"}],staticStyle:{"margin-right":"40px"},attrs:{size:"mini",type:"text",icon:"el-icon-caret-right"},on:{click:function(n){return e.handleRun(t.row)}}},[e._v("执行一次")])]}}])})],1),n("pagination",{directives:[{name:"show",rawName:"v-show",value:e.total>0,expression:"total>0"}],attrs:{total:e.total,page:e.queryParams.pageNum,limit:e.queryParams.pageSize},on:{"update:page":function(t){return e.$set(e.queryParams,"pageNum",t)},"update:limit":function(t){return e.$set(e.queryParams,"pageSize",t)},pagination:e.getList}}),n("el-dialog",{attrs:{title:e.title,visible:e.open,width:"900px","append-to-body":""},on:{"update:visible":function(t){e.open=t}}},[n("div",{staticClass:"el-divider el-divider--horizontal",staticStyle:{"margin-top":"-25px"}}),n("el-form",{ref:"form",attrs:{model:e.form,rules:e.rules,"label-width":"90px"}},[n("el-row",{attrs:{gutter:50}},[n("el-col",{attrs:{span:12}},[n("el-form-item",{attrs:{label:"场景名称",prop:"sceneName"}},[n("el-input",{attrs:{placeholder:"请输入场景名称"},model:{value:e.form.sceneName,callback:function(t){e.$set(e.form,"sceneName",t)},expression:"form.sceneName"}})],1),n("el-form-item",{attrs:{label:"场景状态"}},[n("el-switch",{attrs:{"active-value":1,"inactive-value":2},model:{value:e.form.status,callback:function(t){e.$set(e.form,"status",t)},expression:"form.status"}})],1)],1),n("el-col",{attrs:{span:12}},[n("el-form-item",{attrs:{label:"备注信息",prop:"remark"}},[n("el-input",{attrs:{type:"textarea",rows:"4",placeholder:"请输入内容"},model:{value:e.form.remark,callback:function(t){e.$set(e.form,"remark",t)},expression:"form.remark"}})],1)],1)],1),n("div",{staticStyle:{height:"1px","background-color":"#ddd",margin:"0 0 20px 0"}}),n("el-form-item",{attrs:{label:"",prop:"triggers"}},[n("el-tooltip",{staticClass:"item",attrs:{slot:"label",effect:"dark",content:"满足任意一个条件触发",placement:"right-start"},slot:"label"},[n("span",[e._v("触发器 "),n("i",{staticClass:"el-icon-question"})])]),e._l(e.formJson.triggers,(function(t,r){return n("div",{key:r,staticStyle:{"margin-bottom":"15px",padding:"10px","background-color":"#f8f8f8","border-radius":"5px"}},[n("el-row",{staticStyle:{"margin-bottom":"5px"}},[n("el-col",{attrs:{span:4}},[n("el-select",{attrs:{placeholder:"请选择",size:"small"},on:{change:function(t){return e.changeTriggerSource(t,r)}},model:{value:t.source,callback:function(n){e.$set(t,"source",n)},expression:"item.source"}},e._l(e.triggerSource,(function(e){return n("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1)],1),1==t.source?n("el-col",{attrs:{span:10,offset:1}},[n("el-input",{staticStyle:{"margin-top":"3px"},attrs:{readonly:"",size:"small",placeholder:"请选择设备"},model:{value:t.deviceName,callback:function(n){e.$set(t,"deviceName",n)},expression:"item.deviceName"}},[n("el-button",{attrs:{slot:"append",size:"small"},on:{click:function(n){return e.selectDevice("trigger",t.deviceId,r)}},slot:"append"},[e._v("选择")])],1)],1):e._e(),0!=r?n("el-col",{attrs:{span:2,offset:1==t.source?7:18}},[n("el-button",{staticStyle:{padding:"5px"},attrs:{size:"small",plain:"",type:"danger",icon:"el-icon-delete"},on:{click:function(t){return e.removeTriggerItem(r)}}},[e._v("删除")])],1):e._e()],1),2==t.source?n("el-row",[n("el-col",{attrs:{span:4}},[n("el-time-picker",{staticStyle:{width:"100%"},attrs:{size:"small","value-format":"HH:mm",format:"HH:mm",placeholder:"选择时间",disabled:1==t.isAdvance},on:{change:function(t){return e.timeChange(t,r)}},model:{value:t.timerTimeValue,callback:function(n){e.$set(t,"timerTimeValue",n)},expression:"item.timerTimeValue"}})],1),n("el-col",{attrs:{span:19,offset:1}},[n("el-select",{staticStyle:{width:"100%"},attrs:{placeholder:"请选择",multiple:"",size:"small",disabled:1==t.isAdvance},on:{change:function(t){return e.weekChange(t,r)}},model:{value:t.timerWeekValue,callback:function(n){e.$set(t,"timerWeekValue",n)},expression:"item.timerWeekValue"}},e._l(e.timerWeeks,(function(e){return n("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1)],1),n("el-col",{staticStyle:{"margin-top":"5px"},attrs:{span:4}},[n("el-checkbox",{staticStyle:{width:"100%"},attrs:{"true-label":1,"false-label":0,border:"",size:"small"},on:{change:function(t){e.customerCronChange(r)}},model:{value:t.isAdvance,callback:function(n){e.$set(t,"isAdvance",n)},expression:"item.isAdvance"}},[e._v("自定义CRON")])],1),n("el-col",{staticStyle:{"margin-top":"10px"},attrs:{span:19,offset:1}},[n("el-input",{attrs:{placeholder:"cron执行表达式",disabled:0==t.isAdvance,size:"small"},model:{value:t.cronExpression,callback:function(n){e.$set(t,"cronExpression",n)},expression:"item.cronExpression"}},[n("template",{slot:"append"},[n("el-button",{attrs:{type:"primary",disabled:0==t.isAdvance},on:{click:function(n){return e.handleShowCron(t,r)}}},[e._v(" 生成表达式 "),n("i",{staticClass:"el-icon-time el-icon--right"})])],1)],2)],1)],1):e._e(),t.thingsModel?n("el-row",[n("el-col",{attrs:{span:4}},[n("el-select",{attrs:{placeholder:"请选择",size:"small"},on:{change:function(t){return e.triggerTypeChange(t,r)}},model:{value:t.type,callback:function(n){e.$set(t,"type",n)},expression:"item.type"}},e._l(e.triggerTypes,(function(e,t){return n("el-option",{key:t+"type",attrs:{label:e.label,value:e.value}})})),1)],1),n("el-col",{attrs:{span:5,offset:1}},[1==t.type?n("el-select",{attrs:{placeholder:"请选择",size:"small"},on:{change:function(t){return e.thingsModelTriggerItemChange(t,r)}},model:{value:t.id,callback:function(n){e.$set(t,"id",n)},expression:"item.id"}},e._l(t.thingsModel.properties,(function(e,t){return n("el-option",{key:t+"triggerProperty",attrs:{label:e.name,value:e.id}})})),1):2==t.type?n("el-select",{attrs:{placeholder:"请选择",size:"small"},on:{change:function(t){return e.thingsModelTriggerItemChange(t,r)}},model:{value:t.id,callback:function(n){e.$set(t,"id",n)},expression:"item.id"}},e._l(t.thingsModel.functions,(function(e,t){return n("el-option",{key:t+"triggerFunc",attrs:{label:e.name,value:e.id}})})),1):3==t.type?n("el-select",{attrs:{placeholder:"请选择",size:"small"},on:{change:function(t){return e.thingsModelTriggerItemChange(t,r)}},model:{value:t.id,callback:function(n){e.$set(t,"id",n)},expression:"item.id"}},e._l(t.thingsModel.events,(function(e,t){return n("el-option",{key:t+"triggerEvents",attrs:{label:e.name,value:e.id}})})),1):e._e()],1),n("el-col",{attrs:{span:4,offset:1}},[1==t.type||2==t.type||3==t.type?n("el-select",{attrs:{placeholder:"请选择操作符",size:"small"},model:{value:t.operator,callback:function(n){e.$set(t,"operator",n)},expression:"item.operator"}},[n("el-option",{key:"=",attrs:{label:"等于（=）",value:"="}}),n("el-option",{key:"!=",attrs:{label:"不等于（!=）",value:"!="}}),n("el-option",{key:">",attrs:{label:"大于（>）",value:">"}}),n("el-option",{key:"<",attrs:{label:"小于（<）",value:"<"}}),n("el-option",{key:">=",attrs:{label:"大于等于（>=）",value:">="}}),n("el-option",{key:"<=",attrs:{label:"小于等于（<=）",value:"<="}}),n("el-option",{key:"contain",attrs:{label:"包含（contain）",value:"contain"}}),n("el-option",{key:"notcontain",attrs:{label:"不包含（not contain）",value:"notcontain"}})],1):e._e()],1),1==t.type||2==t.type||3==t.type?n("el-col",{attrs:{span:8,offset:1}},[!t.thingsModelItem||"integer"!=t.thingsModelItem.datatype.type&&"decimal"!=t.thingsModelItem.datatype.type?t.thingsModelItem&&"bool"==t.thingsModelItem.datatype.type?n("span",[n("el-switch",{attrs:{"active-text":t.thingsModelItem.datatype.trueText,"inactive-text":t.thingsModelItem.datatype.falseText,"active-value":"1","inactive-value":"0"},model:{value:t.value,callback:function(n){e.$set(t,"value",n)},expression:"item.value"}})],1):t.thingsModelItem&&"enum"==t.thingsModelItem.datatype.type?n("span",[n("el-select",{staticStyle:{width:"100%"},attrs:{placeholder:"请选择",size:"small"},model:{value:t.value,callback:function(n){e.$set(t,"value",n)},expression:"item.value"}},e._l(t.thingsModelItem.datatype.enumList,(function(e,t){return n("el-option",{key:t+"things",attrs:{label:e.text,value:e.value}})})),1)],1):t.thingsModelItem&&"string"==t.thingsModelItem.datatype.type?n("span",[n("el-input",{attrs:{placeholder:"请输入字符串",max:t.thingsModelItem.datatype.maxLength},model:{value:t.value,callback:function(n){e.$set(t,"value",n)},expression:"item.value"}})],1):t.thingsModelItem&&"array"==t.thingsModelItem.datatype.type?n("span",[n("el-input",{attrs:{placeholder:"请输入英文逗号分隔的数组"},model:{value:t.value,callback:function(n){e.$set(t,"value",n)},expression:"item.value"}})],1):e._e():n("span",[n("el-input",{attrs:{placeholder:"值",max:t.thingsModelItem.datatype.max,min:t.thingsModelItem.datatype.min,type:"number",size:"small"},model:{value:t.value,callback:function(n){e.$set(t,"value",n)},expression:"item.value"}},[n("template",{slot:"append"},[e._v(e._s(t.thingsModelItem.datatype.unit))])],2)],1)]):e._e()],1):e._e()],1)})),n("div",[e._v("+ "),n("a",{staticStyle:{color:"#409EFF"},on:{click:function(t){return e.addTriggerItem()}}},[e._v("添加触发器")])])],2),n("el-divider"),n("el-form-item",{attrs:{label:"执行动作"}},[e._l(e.formJson.actions,(function(t,r){return n("div",{key:r,staticStyle:{"margin-bottom":"15px",padding:"10px","background-color":"#f8f8f8","border-radius":"5px"}},[n("el-row",{staticStyle:{"margin-bottom":"10px"}},[n("el-col",{attrs:{span:10}},[n("el-input",{staticStyle:{"margin-top":"3px"},attrs:{readonly:"",size:"small",placeholder:"请选择设备"},model:{value:t.deviceName,callback:function(n){e.$set(t,"deviceName",n)},expression:"item.deviceName"}},[n("el-button",{attrs:{slot:"append",size:"small"},on:{click:function(n){return e.selectDevice("action",t.deviceId,r)}},slot:"append"},[e._v("选择")])],1)],1),n("el-col",{attrs:{span:2,offset:12}},[0!=r?n("el-button",{staticStyle:{padding:"5px"},attrs:{size:"small",plain:"",type:"danger",icon:"el-icon-delete"},on:{click:function(t){return e.removeActionItem(r)}}},[e._v("删除")]):e._e()],1)],1),t.thingsModel?n("el-row",[n("el-col",{attrs:{span:4}},[n("el-select",{attrs:{placeholder:"请选择",size:"small"},on:{change:function(t){return e.actionTypeChange(t,r)}},model:{value:t.type,callback:function(n){e.$set(t,"type",n)},expression:"item.type"}},e._l(e.actionTypes,(function(e,t){return n("el-option",{key:t+"type",attrs:{label:e.label,value:e.value}})})),1)],1),n("el-col",{attrs:{span:5,offset:1}},[1==t.type?n("el-select",{attrs:{placeholder:"请选择",size:"small"},on:{change:function(t){return e.thingsModelActionItemChange(t,r)}},model:{value:t.id,callback:function(n){e.$set(t,"id",n)},expression:"item.id"}},e._l(t.thingsModel.propertiesExceptMonitor,(function(e,t){return n("el-option",{key:t+"actionProperty",attrs:{label:e.name,value:e.id}})})),1):2==t.type?n("el-select",{attrs:{placeholder:"请选择",size:"small"},on:{change:function(t){return e.thingsModelActionItemChange(t,r)}},model:{value:t.id,callback:function(n){e.$set(t,"id",n)},expression:"item.id"}},e._l(t.thingsModel.functions,(function(e,t){return n("el-option",{key:t+"actionFunc",attrs:{label:e.name,value:e.id}})})),1):e._e()],1),n("el-col",{attrs:{span:10,offset:1}},[!t.thingsModelItem||"integer"!=t.thingsModelItem.datatype.type&&"decimal"!=t.thingsModelItem.datatype.type?t.thingsModelItem&&"bool"==t.thingsModelItem.datatype.type?n("span",[n("el-switch",{attrs:{"active-text":t.thingsModelItem.datatype.trueText,"inactive-text":t.thingsModelItem.datatype.falseText,"active-value":"1","inactive-value":"0"},model:{value:t.value,callback:function(n){e.$set(t,"value",n)},expression:"item.value"}})],1):t.thingsModelItem&&"enum"==t.thingsModelItem.datatype.type?n("span",[n("el-select",{staticStyle:{width:"100%"},attrs:{placeholder:"请选择",size:"small"},model:{value:t.value,callback:function(n){e.$set(t,"value",n)},expression:"item.value"}},e._l(t.thingsModelItem.datatype.enumList,(function(e,t){return n("el-option",{key:t+"things",attrs:{label:e.text,value:e.value}})})),1)],1):t.thingsModelItem&&"string"==t.thingsModelItem.datatype.type?n("span",[n("el-input",{attrs:{placeholder:"请输入字符串",max:t.thingsModelItem.datatype.maxLength},model:{value:t.value,callback:function(n){e.$set(t,"value",n)},expression:"item.value"}})],1):t.thingsModelItem&&"array"==t.thingsModelItem.datatype.type?n("span",[n("el-input",{attrs:{placeholder:"请输入英文逗号分隔的数组"},model:{value:t.value,callback:function(n){e.$set(t,"value",n)},expression:"item.value"}})],1):e._e():n("span",[n("el-input",{attrs:{placeholder:"值",max:t.thingsModelItem.datatype.max,min:t.thingsModelItem.datatype.min,type:"number",size:"small"},model:{value:t.value,callback:function(n){e.$set(t,"value",n)},expression:"item.value"}},[n("template",{slot:"append"},[e._v(e._s(t.thingsModelItem.datatype.unit))])],2)],1)])],1):e._e()],1)})),n("div",[e._v("+ "),n("a",{staticStyle:{color:"#409EFF"},on:{click:function(t){return e.addActionItem()}}},[e._v("添加执行动作")])])],2)],1),n("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[n("el-button",{directives:[{name:"hasPermi",rawName:"v-hasPermi",value:["iot:scene:edit"],expression:"['iot:scene:edit']"},{name:"show",rawName:"v-show",value:e.form.sceneId,expression:"form.sceneId"}],attrs:{type:"primary",disabled:e.updateBtnDisabled,loading:e.confirmLoading},on:{click:e.submitForm}},[e._v("修 改")]),n("el-button",{directives:[{name:"hasPermi",rawName:"v-hasPermi",value:["iot:scene:add"],expression:"['iot:scene:add']"},{name:"show",rawName:"v-show",value:!e.form.sceneId,expression:"!form.sceneId"}],attrs:{type:"primary",disabled:e.updateBtnDisabled,loading:e.confirmLoading},on:{click:e.submitForm}},[e._v("新 增")]),n("el-button",{on:{click:e.cancel}},[e._v("取 消")])],1)],1),n("deviceList",{ref:"deviceList",on:{deviceEvent:function(t){return e.getSelectDevice(t)}}})],1),n("el-dialog",{staticClass:"scrollbar",attrs:{title:"Cron表达式生成器",visible:e.openCron,"append-to-body":"","destroy-on-close":""},on:{"update:visible":function(t){e.openCron=t}}},[n("crontab",{staticStyle:{"padding-bottom":"80px"},attrs:{expression:e.expression},on:{hide:function(t){e.openCron=!1},fill:e.crontabFill}})],1)],1)},i=[],o=n("5530"),s=n("c7eb"),a=n("1da1"),l=(n("d81d"),n("a9e3"),n("b0c0"),n("e9c4"),n("a434"),n("4e82"),n("4de4"),n("d3b7"),n("b775"));function c(e){return Object(l["a"])({url:"/iot/scene/list",method:"get",params:e})}function u(e){return Object(l["a"])({url:"/iot/scene/"+e,method:"get"})}function d(e){return Object(l["a"])({url:"/iot/scene",method:"post",data:e})}function m(e){return Object(l["a"])({url:"/iot/scene",method:"put",data:e})}function g(e){return Object(l["a"])({url:"/iot/scene/"+e,method:"delete"})}var p=n("01ca"),f=n("bdd0"),h=n("ed76"),v={name:"scene",components:{deviceList:h["default"],Crontab:f["a"]},data:function(){return{confirmLoading:!1,updateBtnDisabled:!0,currentType:null,currentIndex:null,loading:!0,ids:[],single:!0,multiple:!0,showSearch:!0,total:0,sceneList:[],title:"",open:!1,openCron:!1,expression:"",triggerIndex:0,queryParams:{pageNum:1,pageSize:10,sceneName:null,userId:null,userName:null},timerWeeks:[{value:1,label:"周一"},{value:2,label:"周二"},{value:3,label:"周三"},{value:4,label:"周四"},{value:5,label:"周五"},{value:6,label:"周六"},{value:7,label:"周日"}],triggerSource:[{value:1,label:"设备触发"},{value:2,label:"定时触发"}],triggerTypes:[{value:1,label:"属性"},{value:2,label:"功能"},{value:3,label:"事件"},{value:5,label:"设备上线"},{value:6,label:"设备下线"}],actionTypes:[{value:1,label:"属性"},{value:2,label:"功能"}],formJson:{triggers:[{timerTimeValue:"",timerWeekValue:[1,2,3,4,5,6,7]}],actions:[]},form:{},rules:{sceneName:[{required:!0,message:"场景名称不能为空",trigger:"blur"}],userId:[{required:!0,message:"用户ID不能为空",trigger:"blur"}],userName:[{required:!0,message:"用户名称不能为空",trigger:"blur"}]}}},created:function(){this.connectMqtt(),this.getList()},methods:{connectMqtt:function(){var e=this;return Object(a["a"])(Object(s["a"])().mark((function t(){return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(null!=e.$mqttTool.client){t.next=3;break}return t.next=3,e.$mqttTool.connect();case 3:case"end":return t.stop()}}),t)})))()},getList:function(){var e=this;this.loading=!0,c(this.queryParams).then((function(t){e.sceneList=t.rows,e.total=t.total,e.loading=!1}))},cancel:function(){this.open=!1,this.reset()},reset:function(){this.form={sceneId:null,sceneName:null,userId:null,userName:null,remark:null,status:1},this.formJson={triggers:[{id:"",name:"",value:"",type:1,deviceId:0,deviceName:"",productId:0,productName:"",source:1,modelType:1,jobId:0,cronExpression:"",isAdvance:0,operator:"=",timerTimeValue:"",timerWeekValue:[1,2,3,4,5,6,7]}],actions:[{id:"",name:"",value:"",type:2}]},this.resetForm("form")},handleQuery:function(){this.queryParams.pageNum=1,this.getList()},resetQuery:function(){this.resetForm("queryForm"),this.handleQuery()},handleSelectionChange:function(e){this.ids=e.map((function(e){return e.sceneId})),this.single=1!==e.length,this.multiple=!e.length},handleAdd:function(){this.reset(),this.updateBtnDisabled=!1,this.open=!0,this.title="添加场景联动"},handleRun:function(e){var t=this,n=JSON.parse(e.actions);console.log(n);for(var r=0;r<n.length;r++){var i="",o="";1==n[r].type?(i="/"+n[r].productId+"/"+n[r].serialNumber+"/property-online/get",o='[{"id":"'+n[r].id+'","value":"'+n[r].value+'"}]'):2==n[r].type&&(i="/"+n[r].productId+"/"+n[r].serialNumber+"/function-online/get",o='[{"id":"'+n[r].id+'","value":"'+n[r].value+'"}]'),""!=i&&this.$mqttTool.publish(i,o,n[r].deviceName).then((function(e){t.$modal.notifySuccess(e)})).catch((function(e){t.$modal.notifyError(e)}))}},handleUpdate:function(e){var t=this;this.reset(),this.updateBtnDisabled=!0;var n=e.sceneId||this.ids;u(n).then((function(e){t.form=e.data,t.formJson.triggers=JSON.parse(t.form.triggers);for(var n=0;n<t.formJson.triggers.length;n++)if(2==t.formJson.triggers[n].source){if(0==t.formJson.triggers[n].isAdvance){var r=t.formJson.triggers[n].cronExpression.substring(12).split(",").map(Number);t.formJson.triggers[n].timerWeekValue=r;var i=t.formJson.triggers[n].cronExpression.substring(5,7)+":"+t.formJson.triggers[n].cronExpression.substring(2,4);t.$set(t.formJson.triggers[n],"timerTimeValue",i)}}else 1==t.formJson.triggers[n].source&&t.getDevice(t.formJson.triggers[n],n,"trigger");t.formJson.actions=JSON.parse(t.form.actions);for(var o=0;o<t.formJson.actions.length;o++)t.getDevice(t.formJson.actions[o],o,"action");setTimeout((function(){t.updateBtnDisabled=!1}),2e3),t.open=!0,t.title="修改场景联动"}))},submitForm:function(){var e=this;this.$refs["form"].validate((function(t){if(t){for(var n=0;n<e.formJson.triggers.length;n++)if(4!=e.formJson.triggers[n].type&&5!=e.formJson.triggers[n].type&&6!=e.formJson.triggers[n].type){if(1==e.formJson.triggers[n].source&&(""==e.formJson.triggers[n].id||""==e.formJson.triggers[n].name||""==e.formJson.triggers[n].value))return void e.$modal.alertError("触发器中的选项和值不能为空");if(2==e.formJson.triggers[n].source)if(0==e.formJson.triggers[n].isAdvance){if(""==e.formJson.triggers[n].timerTimeValue||null==e.formJson.triggers[n].timerTimeValue)return void e.$modal.alertError("执行时间不能空");if(null==e.formJson.triggers[n].timerWeekValue||""==e.formJson.triggers[n].timerWeekValue)return void e.$modal.alertError("请选择要执行的星期")}else if(1==e.formJson.triggers[n].isAdvance&&""==e.formJson.triggers[n].cronExpression)return void e.$modal.alertError("cron表达式不能为空");delete e.formJson.triggers[n].thingsModelItem,delete e.formJson.triggers[n].thingsModel,delete e.formJson.triggers[n].timerTimeValue,delete e.formJson.triggers[n].timerWeekValue,delete e.formJson.triggers[n].timerWeekRepeatValue}for(var r=0;r<e.formJson.actions.length;r++){if(""==e.formJson.actions[r].id||""==e.formJson.actions[r].name||""==e.formJson.actions[r].value)return void e.$modal.alertError("执行动作中的选项和值不能为空");delete e.formJson.actions[r].thingsModelItem,delete e.formJson.actions[r].thingsModel}e.form.userId=1,e.form.userName="admin",e.form.triggers=JSON.stringify(e.formJson.triggers),e.form.actions=JSON.stringify(e.formJson.actions),e.confirmLoading=!0,null!=e.form.sceneId?m(e.form).then((function(t){e.$modal.msgSuccess("修改成功"),e.open=!1,e.confirmLoading=!1,e.getList()})):d(e.form).then((function(t){e.$modal.msgSuccess("新增成功"),e.open=!1,e.confirmLoading=!1,e.getList()}))}}))},handleDelete:function(e){var t=this,n=e.sceneId||this.ids;this.$modal.confirm('是否确认删除场景联动编号为"'+n+'"的数据项？').then((function(){return g(n)})).then((function(){t.getList(),t.$modal.msgSuccess("删除成功")})).catch((function(){}))},handleExport:function(){this.download("iot/scene/export",Object(o["a"])({},this.queryParams),"scene_".concat((new Date).getTime(),".xlsx"))},addActionItem:function(){this.formJson.actions.push({id:"",name:"",value:"",type:2,deviceId:0,deviceName:"",productId:1,productName:""})},removeActionItem:function(e){this.formJson.actions.splice(e,1)},changeTriggerSource:function(e,t){2==e&&(this.formJson.triggers[t].deviceId=0,this.formJson.triggers[t].deviceName="",this.formJson.triggers[t].productId=0,this.formJson.triggers[t].productName="",this.formJson.triggers[t].serialNumber="",this.formJson.triggers[t].id="",this.formJson.triggers[t].name="",this.formJson.triggers[t].value="",this.formJson.triggers[t].thingsModelItem=null,this.formJson.triggers[t].thingsModel=null,this.formJson.triggers[t].operator="",this.formJson.triggers[t].timerTimeValue="",this.formJson.triggers[t].timerWeekValue=[1,2,3,4,5,6,7])},addTriggerItem:function(){this.formJson.triggers.push({id:"",name:"",value:"",type:1,deviceId:0,deviceName:"",serialNumber:null,productId:0,productName:"",source:1,jobId:0,cronExpression:"",isAdvance:0,operator:"=",timerTimeValue:"",timerWeekValue:[1,2,3,4,5,6,7]})},removeTriggerItem:function(e){this.formJson.triggers.splice(e,1)},handleShowCron:function(e,t){this.expression=e.cronExpression,this.triggerIndex=t,this.openCron=!0},crontabFill:function(e){this.formJson.triggers[this.triggerIndex].cronExpression=e},weekChange:function(e,t){this.gentCronExpression(t)},timeChange:function(e,t){console.log("时间改变了",e),this.gentCronExpression(t)},customerCronChange:function(e,t){},gentCronExpression:function(e){var t="00",n="00";null!=this.formJson.triggers[e].timerTimeValue&&""!=this.formJson.triggers[e].timerTimeValue&&(t=this.formJson.triggers[e].timerTimeValue.substring(0,2),n=this.formJson.triggers[e].timerTimeValue.substring(3));var r="*";this.formJson.triggers[e].timerWeekValue.length>0&&(r=this.formJson.triggers[e].timerWeekValue.sort()),this.formJson.triggers[e].cronExpression="0 "+n+" "+t+" ? * "+r},triggerTypeChange:function(e,t){this.formJson.triggers[t].id="",this.formJson.triggers[t].name="",this.formJson.triggers[t].value="",this.formJson.triggers[t].thingsModelItem=null,this.formJson.triggers[t].operator="="},thingsModelTriggerItemChange:function(e,t){if(this.formJson.triggers[t].value="",1==this.formJson.triggers[t].type){for(var n=0;n<this.formJson.triggers[t].thingsModel.properties.length;n++)if(this.formJson.triggers[t].thingsModel.properties[n].id==e){this.formJson.triggers[t].name=this.formJson.triggers[t].thingsModel.properties[n].name,this.formJson.triggers[t].thingsModelItem=this.formJson.triggers[t].thingsModel.properties[n];break}}else if(2==this.formJson.triggers[t].type){for(var r=0;r<this.formJson.triggers[t].thingsModel.functions.length;r++)if(this.formJson.triggers[t].thingsModel.functions[r].id==e){this.formJson.triggers[t].name=this.formJson.triggers[t].thingsModel.functions[r].name,this.formJson.triggers[t].thingsModelItem=this.formJson.triggers[t].thingsModel.functions[r];break}}else if(3==this.formJson.triggers[t].type)for(var i=0;i<this.formJson.triggers[t].thingsModel.events.length;i++)if(this.formJson.triggers[t].thingsModel.events[i].id==e){this.formJson.triggers[t].name=this.formJson.triggers[t].thingsModel.events[i].name,this.formJson.triggers[t].thingsModelItem=this.formJson.triggers[t].thingsModel.events[i];break}},actionTypeChange:function(e,t){this.formJson.actions[t].id=null,this.formJson.actions[t].value=null,this.formJson.actions[t].thingsModelItem=null},thingsModelActionItemChange:function(e,t){if(this.formJson.actions[t].value="",1==this.formJson.actions[t].type){for(var n=0;n<this.formJson.actions[t].thingsModel.properties.length;n++)if(this.formJson.actions[t].thingsModel.properties[n].id==e){this.formJson.actions[t].name=this.formJson.actions[t].thingsModel.properties[n].name,this.formJson.actions[t].thingsModelItem=this.formJson.actions[t].thingsModel.properties[n];break}}else if(2==this.formJson.actions[t].type)for(var r=0;r<this.formJson.actions[t].thingsModel.functions.length;r++)if(this.formJson.actions[t].thingsModel.functions[r].id==e){this.formJson.actions[t].name=this.formJson.actions[t].thingsModel.functions[r].name,this.formJson.actions[t].thingsModelItem=this.formJson.actions[t].thingsModel.functions[r];break}},getDevice:function(e,t,n){var r=this;"action"==n?Object(p["b"])(e.productId).then((function(e){if(r.formJson.actions[t].thingsModel=JSON.parse(e.data),r.formJson.actions[t].thingsModel.propertiesExceptMonitor=r.formJson.actions[t].thingsModel.properties.filter((function(e){return 0==e.isMonitor})),1==r.formJson.actions[t].type){for(var n=0;n<r.formJson.actions[t].thingsModel.properties.length;n++)if(r.formJson.actions[t].id==r.formJson.actions[t].thingsModel.properties[n].id){r.formJson.actions[t].thingsModelItem=r.formJson.actions[t].thingsModel.properties[n];break}}else if(2==r.formJson.actions[t].type)for(var i=0;i<r.formJson.actions[t].thingsModel.functions.length;i++)if(r.formJson.actions[t].id==r.formJson.actions[t].thingsModel.functions[i].id){r.formJson.actions[t].thingsModelItem=r.formJson.actions[t].thingsModel.functions[i];break}r.$set(r.formJson.actions,t,r.formJson.actions[t])})):"trigger"==n&&Object(p["b"])(e.productId).then((function(e){if(r.formJson.triggers[t].thingsModel=JSON.parse(e.data),r.formJson.triggers[t].thingsModel.propertiesExceptMonitor=r.formJson.triggers[t].thingsModel.properties.filter((function(e){return 0==e.isMonitor})),1==r.formJson.triggers[t].type){for(var n=0;n<r.formJson.triggers[t].thingsModel.properties.length;n++)if(r.formJson.triggers[t].id==r.formJson.triggers[t].thingsModel.properties[n].id){r.formJson.triggers[t].thingsModelItem=r.formJson.triggers[t].thingsModel.properties[n];break}}else if(2==r.formJson.triggers[t].type){for(var i=0;i<r.formJson.triggers[t].thingsModel.functions.length;i++)if(r.formJson.triggers[t].id==r.formJson.triggers[t].thingsModel.functions[i].id){r.formJson.triggers[t].thingsModelItem=r.formJson.triggers[t].thingsModel.functions[i];break}}else if(3==r.formJson.triggers[t].type)for(var o=0;o<r.formJson.triggers[t].thingsModel.events.length;o++)if(console.log(r.formJson.triggers[t].thingsModel),r.formJson.triggers[t].id==r.formJson.triggers[t].thingsModel.events[o].id){r.formJson.triggers[t].thingsModelItem=r.formJson.triggers[t].thingsModel.events[o];break}r.$set(r.formJson.triggers,t,r.formJson.triggers[t])}))},selectDevice:function(e,t,n){this.currentType=e,this.currentIndex=n,this.$refs.deviceList.openDeviceList=!0,this.$refs.deviceList.getList(t)},getSelectDevice:function(e){var t=this;null!=this.currentType&&("trigger"==this.currentType?(this.formJson.triggers[this.currentIndex].deviceId=e.deviceId,this.formJson.triggers[this.currentIndex].deviceName=e.deviceName,this.formJson.triggers[this.currentIndex].serialNumber=e.serialNumber,this.formJson.triggers[this.currentIndex].productId=e.productId,this.formJson.triggers[this.currentIndex].productName=e.productName,Object(p["b"])(e.productId).then((function(e){t.formJson.triggers[t.currentIndex].thingsModel=JSON.parse(e.data),t.formJson.triggers[t.currentIndex].thingsModel.propertiesExceptMonitor=t.formJson.triggers[t.currentIndex].thingsModel.properties.filter((function(e){return 0==e.isMonitor})),t.formJson.triggers[t.currentIndex].id=null,t.formJson.triggers[t.currentIndex].thingsModelItem=null,t.formJson.triggers[t.currentIndex].value="",t.formJson.triggers[t.currentIndex].operator="=",t.$set(t.formJson.triggers,t.currentIndex,t.formJson.triggers[t.currentIndex])}))):"action"==this.currentType&&(this.formJson.actions[this.currentIndex].deviceId=e.deviceId,this.formJson.actions[this.currentIndex].deviceName=e.deviceName,this.formJson.actions[this.currentIndex].serialNumber=e.serialNumber,this.formJson.actions[this.currentIndex].productId=e.productId,this.formJson.actions[this.currentIndex].productName=e.productName,Object(p["b"])(e.productId).then((function(e){t.formJson.actions[t.currentIndex].thingsModel=JSON.parse(e.data),t.formJson.actions[t.currentIndex].thingsModel.propertiesExceptMonitor=t.formJson.actions[t.currentIndex].thingsModel.properties.filter((function(e){return 0==e.isMonitor})),t.formJson.actions[t.currentIndex].id=null,t.formJson.actions[t.currentIndex].value=null,t.formJson.actions[t.currentIndex].thingsModelItem=null,t.$set(t.formJson.actions,t.currentIndex,t.formJson.actions[t.currentIndex])}))))},formatActionsDisplay:function(e){if(null!=e&&""!=e){for(var t=JSON.parse(e),n="",r=0;r<t.length;r++)n=n+'<span style="font-weight:bold;margin-right:10px;">'+t[r].deviceName+"</span>",n=n+t[r].name+'值：<span style="color:#F56C6C">'+t[r].value+"</span><br />";return""==n?"无":n}},formatTriggersDisplay:function(e){if(null!=e&&""!=e){for(var t=JSON.parse(e),n="",r=0;r<t.length;r++)2!=t[r].source?(n=n+'<span style="font-weight:bold;margin-right:10px;">'+t[r].deviceName+"</span>",1==t[r].type||2==t[r].type||3==t[r].type?n=n+t[r].name+' <span style="color:#F56C6C">'+t[r].operator+" "+t[r].value+"</span><br />":4==t[r].type?n+='<span style="color:#F56C6C">设备升级</span><br />':5==t[r].type?n+='<span style="color:#F56C6C">设备上线</span><br />':6==t[r].type&&(n+='<span style="color:#F56C6C">设备下线</span><br />')):(n+='<span style="font-weight:bold;margin-right:10px;">定时触发</span>',n=n+'<span style="color:#F56C6C"> '+t[r].cronExpression+"</span><br />");return n}}}},b=v,y=n("2877"),J=Object(y["a"])(b,r,i,!1,null,null,null);t["default"]=J.exports},"584f":function(e,t,n){"use strict";n.d(t,"l",(function(){return i})),n.d(t,"j",(function(){return o})),n.d(t,"k",(function(){return s})),n.d(t,"i",(function(){return a})),n.d(t,"e",(function(){return l})),n.d(t,"c",(function(){return c})),n.d(t,"f",(function(){return u})),n.d(t,"h",(function(){return d})),n.d(t,"g",(function(){return m})),n.d(t,"a",(function(){return g})),n.d(t,"m",(function(){return p})),n.d(t,"b",(function(){return f})),n.d(t,"d",(function(){return h}));var r=n("b775");function i(e){return Object(r["a"])({url:"/iot/device/unAuthlist",method:"get",params:e})}function o(e){return Object(r["a"])({url:"/iot/device/listByGroup",method:"get",params:e})}function s(e){return Object(r["a"])({url:"/iot/device/shortList",method:"get",params:e})}function a(){return Object(r["a"])({url:"/iot/device/all",method:"get"})}function l(e){return Object(r["a"])({url:"/iot/device/"+e,method:"get"})}function c(e){return Object(r["a"])({url:"/iot/device/synchronization/"+e,method:"get"})}function u(e){return Object(r["a"])({url:"/iot/device/getDeviceBySerialNumber/"+e,method:"get"})}function d(){return Object(r["a"])({url:"/iot/device/statistic",method:"get"})}function m(e){return Object(r["a"])({url:"/iot/device/runningStatus/"+e,method:"get"})}function g(e){return Object(r["a"])({url:"/iot/device",method:"post",data:e})}function p(e){return Object(r["a"])({url:"/iot/device",method:"put",data:e})}function f(e){return Object(r["a"])({url:"/iot/device/"+e,method:"delete"})}function h(){return Object(r["a"])({url:"/iot/device/generator",method:"get"})}},ed76:function(e,t,n){"use strict";n.r(t);var r=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("el-dialog",{attrs:{title:"选择设备",visible:e.openDeviceList,width:"800px","append-to-body":""},on:{"update:visible":function(t){e.openDeviceList=t}}},[n("el-form",{ref:"queryForm",attrs:{model:e.queryParams,inline:!0,"label-width":"68px"}},[n("el-form-item",{attrs:{label:"设备名称",prop:"deviceName"}},[n("el-input",{attrs:{placeholder:"请输入设备名称",clearable:"",size:"small"},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleQuery(t)}},model:{value:e.queryParams.deviceName,callback:function(t){e.$set(e.queryParams,"deviceName",t)},expression:"queryParams.deviceName"}})],1),n("el-form-item",{attrs:{label:"设备编号",prop:"serialNumber"}},[n("el-input",{attrs:{placeholder:"请输入设备编号",clearable:"",size:"small"},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleQuery(t)}},model:{value:e.queryParams.serialNumber,callback:function(t){e.$set(e.queryParams,"serialNumber",t)},expression:"queryParams.serialNumber"}})],1),n("el-form-item",[n("el-button",{attrs:{type:"primary",icon:"el-icon-search",size:"mini"},on:{click:e.handleQuery}},[e._v("搜索")]),n("el-button",{attrs:{icon:"el-icon-refresh",size:"mini"},on:{click:e.resetQuery}},[e._v("重置")])],1)],1),n("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],attrs:{data:e.deviceList,"highlight-current-row":"",size:"mini"},on:{"row-click":e.rowClick}},[n("el-table-column",{attrs:{label:"选择",width:"50",align:"center"},scopedSlots:e._u([{key:"default",fn:function(e){return[n("input",{attrs:{type:"radio",name:"product"},domProps:{checked:e.row.isSelect}})]}}])}),n("el-table-column",{attrs:{label:"设备名称",align:"center",prop:"deviceName"}}),n("el-table-column",{attrs:{label:"设备编号",align:"center",prop:"serialNumber"}}),n("el-table-column",{attrs:{label:"产品名称",align:"center",prop:"productName"}}),n("el-table-column",{attrs:{label:"设备类型",align:"center",width:"100"},scopedSlots:e._u([{key:"default",fn:function(t){return[0==t.row.isOwner?n("el-tag",{attrs:{type:"success"}},[e._v("分享")]):n("el-tag",{attrs:{type:"primary"}},[e._v("拥有")])]}}])}),n("el-table-column",{attrs:{label:"定位方式",align:"center",prop:"locationWay",width:"100"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("dict-tag",{attrs:{options:e.dict.type.iot_location_way,value:t.row.locationWay}})]}}])}),n("el-table-column",{attrs:{label:"设备状态",align:"center",prop:"status",width:"100"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("dict-tag",{attrs:{options:e.dict.type.iot_device_status,value:t.row.status}})]}}])})],1),n("pagination",{directives:[{name:"show",rawName:"v-show",value:e.total>0,expression:"total>0"}],attrs:{total:e.total,page:e.queryParams.pageNum,limit:e.queryParams.pageSize},on:{"update:page":function(t){return e.$set(e.queryParams,"pageNum",t)},"update:limit":function(t){return e.$set(e.queryParams,"pageSize",t)},pagination:e.getList}}),n("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[n("el-button",{attrs:{type:"primary"},on:{click:e.confirmSelectDevice}},[e._v("确 定")]),n("el-button",{on:{click:e.closeSelectDeviceList}},[e._v("取 消")])],1)],1)},i=[],o=n("ade3"),s=n("584f"),a={name:"device-list",dicts:["iot_device_status","iot_location_way"],data:function(){var e;return{loading:!0,ids:[],openDeviceList:!1,total:0,deviceList:[],selectDevice:{},queryParams:(e={pageNum:1,pageSize:10,deviceName:null,productId:null,groupId:null},Object(o["a"])(e,"groupId",null),Object(o["a"])(e,"productName",null),Object(o["a"])(e,"userId",null),Object(o["a"])(e,"userName",null),Object(o["a"])(e,"tenantId",null),Object(o["a"])(e,"tenantName",null),Object(o["a"])(e,"serialNumber",null),Object(o["a"])(e,"status",null),Object(o["a"])(e,"networkAddress",null),Object(o["a"])(e,"activeTime",null),e)}},created:function(){},methods:{getList:function(e){var t=this;this.deviceList=[],this.total=0,this.loading=!0,Object(s["k"])(this.queryParams).then((function(n){t.deviceList=n.rows,t.total=n.total,0!=e&&t.setRadioSelected(e),t.loading=!1}))},handleQuery:function(){this.queryParams.pageNum=1,this.getList()},resetQuery:function(){this.resetForm("queryForm"),this.handleQuery()},rowClick:function(e){null!=e&&(this.setRadioSelected(e.deviceId),this.selectDevice=e)},setRadioSelected:function(e){for(var t=0;t<this.deviceList.length;t++)this.deviceList[t].deviceId==e?this.deviceList[t].isSelect=!0:this.deviceList[t].isSelect=!1},closeSelectDeviceList:function(){this.openDeviceList=!1},confirmSelectDevice:function(){this.$emit("deviceEvent",this.selectDevice),this.openDeviceList=!1}}},l=a,c=n("2877"),u=Object(c["a"])(l,r,i,!1,null,null,null);t["default"]=u.exports}}]);